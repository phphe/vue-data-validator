!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(e.vueDataValidatorValidator=e.vueDataValidatorValidator||{},e.vueDataValidatorValidator.js=r())}(this,function(){"use strict";function e(e){return void 0!==e}function r(e){return"[object Boolean]"===Object.prototype.toString.call(e)}function t(e){return"[object Number]"===Object.prototype.toString.call(e)}function i(e){return"[object Object]"===Object.prototype.toString.call(e)}function a(e){return"function"==typeof e}function n(e){return"[object Promise]"===Object.prototype.toString.call(e)}function s(e){return null==e||(null!=e.length?0===e.length:!r(e)&&(t(e)?isNaN(e):i(e)?0===Object.keys(e).length:void 0))}function l(e,r){var t={};for(var i in e)t[i]=r(e[i],i,e);return t}return{rules:{},messages:{},validClass:"has-success",invalidClass:"has-error",validtingClass:"",install:function(e){e.validator=e.prototype.$validator=this,e.prototype.$validate=function(r,t){return e.validator.validate(r,t,this)}},validate:function(e,r,t){var i=this;e.clear&&e.clear(),this.initValidation(e,r,t),this.initFields(e,t),Object.values(r).forEach(function(r){return i.validateField(r,e)})},initValidation:function(e,r,t){var i={fields:r,dirty:!1,valid:!1,validating:!1,_sensitiveFields:[],vm:t,getValues:function(){return l(this.fields,function(e){return e.value})},setValues:function(e){for(var r in e)this.fields.hasOwnProperty(r)&&(this.fields[r].value=e[r]);return this},setDirty:function(e){return this.dirty=e,Object.values(this.fields).forEach(function(r){r.dirty=e}),this},check:function(){var e=this;return new Promise(function(r,t){e.validating?t(new Error("Data is being validated")):e.valid?r(e.getValues()):(e.setDirty(!0),t(new Error("Data is invalid")))})},unwatch:function(){Object.values(this.fields).forEach(function(e){e.watcher&&e.watcher.unwatch&&e.watcher.unwatch()})},pause:function(){this.unwatch()},continue:function(){var e=this;this.unwatch(),Object.values(this.fields).forEach(function(r){var t=r.watcher;t.unwatch=e.vm.$watch(t.getValue,t.handler)})},clear:function(){this.unwatch(),Object.values(this.fields).forEach(function(e){e.required=!1,e.dirty=!1}),this.dirty=!1}};for(var a in i)t.$set(e,a,i[a])},initFields:function(r,t){var i=this;for(var a in r.fields)!function(a){var n=r.fields[a];if(n.name){if(n.name!==a)throw Error("The field name must be same with its key.")}else t.$set(n,"name",a);e(n.value)||t.$set(n,"value",null),t.$set(n,"dirty",!1),t.$set(n,"valid",!1),t.$set(n,"errors",{}),t.$set(n,"required",!1),t.$set(n,"validating",!1),t.$set(n,"_resolvedRules",i.resolveRules(n)),t.$set(n,"errorsVisible",function(){return n.rules&&!n.validating&&n.dirty&&!n.valid}),t.$set(n,"validationClass",function(){return n.rules&&n.dirty?n.validating?i.validatingClass:n.valid?i.validClass:i.invalidClass:null}),Object.values(n._resolvedRules).find(function(e){return e.sensitive})&&r._sensitiveFields.push(n);var s={getValue:function(){return n.value},handler:function(e){i.validateField(n,r),n.dirty=!0,r.dirty=!0,r._sensitiveFields.filter(function(e){return e!==n}).forEach(function(e){i.validateField(e,r)})}};s.unwatch=t.$watch(s.getValue,s.handler),t.$set(n,"watcher",s)}(a)},resolveRules:function(e){var r={};if(e.rules){var t=e.rules.split("|");for(var i in t){var n=t[i].split(":"),s=n[1]?n[1].split(","):[],l=n[0];e.ruleParams&&e.ruleParams[l]&&(s=s.concat(e.ruleParams[l]));var o=e.customRules&&e.customRules[l]||this.rules[l];if(a(o)&&(o={handler:o}),null==o)throw Error("Rule '"+l+"' of field '"+e.name+"' is not found.");r[l]={name:l,params:s,required:o.required,sensitive:o.sensitive,handler:o.handler,message:e.messages&&e.messages[l]||this.messages&&this.messages[l]||"No error message for :name."}}}return r},validateField:function(e,r){var t=this,i={};e._validationId=i,r.validating=!0,e.validating=!0,this.removeFieldAllErrors(e,r);var a=Object.values(e._resolvedRules),n=function(){e._validationId=null,e.validating=!1,r.validating=Object.values(r.fields).some(function(e){return e.validating})},s=function(){if(0===a.length)n();else{var l=a.shift();t.validateRule(l,e,r,i).then(function(){i===e._validationId&&s()}).catch(function(e){n()})}};s()},validateRule:function(e,r,t,i){var l=this;return null!=e.required&&(r.required=a(e.required)?e.required(r.value,e.params,r,t.fields,t,t.vm.constructor):e.required),new Promise(function(a,o){if(r.required||!s(r.value)){var u=e.handler(r.value,e.params,r,t.fields,t,t.vm.constructor);n(u)||(u=u?Promise.resolve():Promise.reject(new Error("invalid. field:"+r.name+", rule:"+e.name))),u.then(function(){i!==r._validationId&&o(new Error("expired")),l.removeFieldError(e,r,t),a()}).catch(function(){i!==r._validationId&&o(new Error("expired")),l.addFieldError(e,r,t),o(new Error("invalid"))})}else a()})},addFieldError:function(e,r,t){var i=r.nameInMessage||r.text&&r.text.toString().toLowerCase()||r.name||"unnamed",a=e.message.replace(/:name/g,i).replace(/:value/g,r.value);for(var n in e.params){var s=new RegExp(":params\\["+n+"\\]","g");a=a.replace(s,e.params[n])}if(!r.errors[e.name]){var l={};for(var o in r._resolvedRules)r.errors[o]?l[o]=r.errors[o]:o===e.name&&(l[o]={});r.errors=l}r.errors[e.name]={name:e.name,message:a},r.valid=!1,t.valid=!1},removeFieldError:function(e,r,t){var i={};for(var a in r.errors)a!==e.name&&(i[a]=r.errors[a]);r.errors=i,r.valid=0===Object.keys(r.errors).length,t.valid=Object.values(t.fields).every(function(e){return e.valid})},removeFieldAllErrors:function(e,r){e.errors={},e.valid=!0,r.valid=Object.values(r.fields).every(function(e){return e.valid})}}});
