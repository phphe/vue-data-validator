!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e.vueDataValidatorValidator=e.vueDataValidatorValidator||{},e.vueDataValidatorValidator.js=t())}(this,function(){"use strict";function e(e){return void 0!==e}function t(e){return"[object Boolean]"===Object.prototype.toString.call(e)}function r(e){return"[object Number]"===Object.prototype.toString.call(e)}function i(e){return"[object Object]"===Object.prototype.toString.call(e)}function a(e){return"function"==typeof e}function n(e){return"[object Promise]"===Object.prototype.toString.call(e)}function s(e){return null==e||(null!=e.length?0===e.length:!t(e)&&(r(e)?isNaN(e):i(e)?0===Object.keys(e).length:void 0))}function l(e,t){var r={};for(var i in e)r[i]=t(e[i],i,e);return r}return{rules:{},messages:{},validClass:"has-success",invalidClass:"has-error",validtingClass:"",install:function(e){e.validator=e.prototype.$validator=this,e.prototype.$validate=function(t,r){return e.validator.validate(t,r,this)}},validate:function(e,t,r){var i=this;return e.clear&&e.clear(),this.initValidation(e,t,r),this.initFields(e,r),Object.values(t).forEach(function(t){return i.validateField(t,e)}),e},initValidation:function(e,t,r){var i={fields:t,dirty:!1,valid:!1,validating:!1,_sensitiveFields:[],vm:r,isSubmitAble:function(){return this.valid&&!this.validating},getValues:function(){return l(this.fields,function(e){return e.value})},setValues:function(e){for(var t in e)this.fields.hasOwnProperty(t)&&(this.fields[t].value=e[t]);return this},setDirty:function(e){return this.dirty=e,Object.values(this.fields).forEach(function(t){t.dirty=e}),this},check:function(){var e=this;return new Promise(function(t,r){e.validating?r(new Error("Data is being validated")):e.valid?t(e.getValues()):(e.setDirty(!0),r(new Error("Data is invalid")))})},unwatch:function(){return Object.values(this.fields).forEach(function(e){e.watcher&&e.watcher.unwatch&&e.watcher.unwatch()}),this},pause:function(){return this.unwatch(),this},continue:function(){var e=this;return this.unwatch(),Object.values(this.fields).forEach(function(t){var r=t.watcher;r.unwatch=e.vm.$watch(r.getValue,r.handler)}),this},clear:function(){return this.unwatch(),this.setDirty(!1),Object.values(this.fields).forEach(function(e){e.required=!1}),this}};for(var a in i)r.$set(e,a,i[a])},initFields:function(t,r){var i=this;for(var a in t.fields)!function(a){var n=t.fields[a];if(n.name){if(n.name!==a)throw Error("The field name must be same with its key.")}else r.$set(n,"name",a);e(n.value)||r.$set(n,"value",null),r.$set(n,"dirty",!1),r.$set(n,"valid",!1),r.$set(n,"errors",{}),r.$set(n,"required",!1),r.$set(n,"validating",!1),r.$set(n,"_resolvedRules",i.resolveRules(n)),r.$set(n,"isValidationErrorsVisible",function(){return n.rules&&!n.validating&&n.dirty&&!n.valid}),r.$set(n,"getValidationClass",function(){return n.rules&&n.dirty?n.validating?i.validatingClass:n.valid?i.validClass:i.invalidClass:null}),Object.values(n._resolvedRules).find(function(e){return e.sensitive})&&t._sensitiveFields.push(n);var s={getValue:function(){return n.value},handler:function(e){i.validateField(n,t),n.dirty=!0,t.dirty=!0,t._sensitiveFields.filter(function(e){return e!==n}).forEach(function(e){i.validateField(e,t)})}};s.unwatch=r.$watch(s.getValue,s.handler),r.$set(n,"watcher",s)}(a)},resolveRules:function(e){var t={};if(e.rules){var r=e.rules.split("|");for(var i in r){var n=r[i].split(":"),s=n[1]?n[1].split(","):[],l=n[0];e.ruleParams&&e.ruleParams[l]&&(s=s.concat(e.ruleParams[l]));var o=e.customRules&&e.customRules[l]||this.rules[l];if(a(o)&&(o={handler:o}),null==o)throw Error("Rule '"+l+"' of field '"+e.name+"' is not found.");t[l]={name:l,params:s,required:o.required,sensitive:o.sensitive,handler:o.handler,message:e.messages&&e.messages[l]||this.messages&&this.messages[l]||"No error message for :name."}}}return t},validateField:function(e,t){var r=this,i={};e._validationId=i,t.validating=!0,e.validating=!0,this.removeFieldAllErrors(e,t);var a=Object.values(e._resolvedRules),n=function(){e._validationId=null,e.validating=!1,t.validating=Object.values(t.fields).some(function(e){return e.validating})},s=function(){if(0===a.length)n();else{var l=a.shift();r.validateRule(l,e,t,i).then(function(){i===e._validationId&&s()}).catch(function(e){n()})}};s()},validateRule:function(e,t,r,i){var l=this;return null!=e.required&&(t.required=a(e.required)?e.required(t.value,e.params,t,r.fields,r,r.vm.constructor):e.required),new Promise(function(a,o){if(t.required||!s(t.value)){var u=e.handler(t.value,e.params,t,r.fields,r,r.vm.constructor);n(u)||(u=u?Promise.resolve():Promise.reject(new Error("invalid. field:"+t.name+", rule:"+e.name))),u.then(function(){i!==t._validationId&&o(new Error("expired")),l.removeFieldError(e,t,r),a()}).catch(function(){i!==t._validationId&&o(new Error("expired")),l.addFieldError(e,t,r),o(new Error("invalid"))})}else a()})},addFieldError:function(e,t,r){var i=t.nameInMessage||t.text&&t.text.toString().toLowerCase()||t.name||"unnamed",a=e.message.replace(/:name/g,i).replace(/:value/g,t.value);for(var n in e.params){var s=new RegExp(":params\\["+n+"\\]","g");a=a.replace(s,e.params[n])}if(!t.errors[e.name]){var l={};for(var o in t._resolvedRules)t.errors[o]?l[o]=t.errors[o]:o===e.name&&(l[o]={});t.errors=l}t.errors[e.name]={name:e.name,message:a},t.valid=!1,r.valid=!1},removeFieldError:function(e,t,r){var i={};for(var a in t.errors)a!==e.name&&(i[a]=t.errors[a]);t.errors=i,t.valid=0===Object.keys(t.errors).length,r.valid=Object.values(r.fields).every(function(e){return e.valid})},removeFieldAllErrors:function(e,t){e.errors={},e.valid=!0,t.valid=Object.values(t.fields).every(function(e){return e.valid})}}});
